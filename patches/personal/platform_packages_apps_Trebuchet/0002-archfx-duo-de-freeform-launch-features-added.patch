From c0b99fab4ac3c7123d7217daf145c9b9c2a3859a Mon Sep 17 00:00:00 2001
From: Archfx <cybx@live.com>
Date: Mon, 24 Jun 2024 20:52:28 -0400
Subject: [PATCH] archfx-duo-de freeform launch features added

---
 res/values/strings.xml                        |  2 +
 res/xml/launcher_preferences.xml              |  7 +++
 .../util/ActivityOptionsWrapper.java          | 47 +++++++++++++++++++
 .../launcher3/views/ActivityContext.java      |  4 ++
 4 files changed, 60 insertions(+)

diff --git a/res/values/strings.xml b/res/values/strings.xml
index aaef15b2af..f784572437 100644
--- a/res/values/strings.xml
+++ b/res/values/strings.xml
@@ -482,4 +482,6 @@
     <!-- Strings for bubble bar -->
     <!-- content description for the overflow bubble [CHAR_LIMIT=none] -->
     <string name="bubble_bar_overflow_description">Overflow</string>
+
+    <string name="allow_freeform_mode">Enable desktop mode</string>
 </resources>
diff --git a/res/xml/launcher_preferences.xml b/res/xml/launcher_preferences.xml
index 83ef5b3bd2..7266597393 100644
--- a/res/xml/launcher_preferences.xml
+++ b/res/xml/launcher_preferences.xml
@@ -96,4 +96,11 @@
         android:defaultValue="true"
         android:persistent="true" />
 
+    <SwitchPreference
+        android:key="allow_freeform_mode"
+        android:title="@string/allow_freeform_mode"
+        android:defaultValue="true"
+        android:persistent="true"
+        />
+
 </androidx.preference.PreferenceScreen>
diff --git a/src/com/android/launcher3/util/ActivityOptionsWrapper.java b/src/com/android/launcher3/util/ActivityOptionsWrapper.java
index 99cc1f7b6c..20e6568b3a 100644
--- a/src/com/android/launcher3/util/ActivityOptionsWrapper.java
+++ b/src/com/android/launcher3/util/ActivityOptionsWrapper.java
@@ -15,9 +15,18 @@
  */
 package com.android.launcher3.util;
 
+import com.android.launcher3.LauncherFiles;
 
 import android.app.ActivityOptions;
 import android.os.Bundle;
+import android.os.Build;
+import android.graphics.Rect;
+
+import java.lang.reflect.Method;
+import android.content.Context;
+import android.content.SharedPreferences;
+import android.content.SharedPreferences.OnSharedPreferenceChangeListener;
+
 
 /**
  * A wrapper around {@link ActivityOptions} to allow custom functionality in launcher
@@ -27,6 +36,8 @@ public class ActivityOptionsWrapper {
     public final ActivityOptions options;
     public final RunnableList onEndCallback;
 
+    private Context context;
+
     public ActivityOptionsWrapper(ActivityOptions options, RunnableList onEndCallback) {
         this.options = options;
         this.onEndCallback = onEndCallback;
@@ -36,6 +47,42 @@ public class ActivityOptionsWrapper {
      * @see {@link ActivityOptions#toBundle()}
      */
     public Bundle toBundle() {
+        
+        String mode = "freeform";
+        int windowMode;
+        Rect rect = new Rect(
+            100,
+            120,
+            1244,
+            1600);
+        
+        if (this.context != null) {
+            SharedPreferences pref = this.context.getSharedPreferences(LauncherFiles.SHARED_PREFERENCES_KEY, Context.MODE_PRIVATE);
+            if(!pref.getBoolean("allow_freeform_mode", true)) 
+                mode = "fullscreen";
+        }
+            
+        if (mode.equals("fullscreen")) {
+            windowMode = 1;
+        } else {
+            windowMode = (Build.VERSION.SDK_INT >= 28) ? 5 : 2;
+            options.setLaunchBounds(rect);
+        }
+                
+        String methodName = (Build.VERSION.SDK_INT >= 28) ? "setLaunchWindowingMode" : "setLaunchStackId";
+        
+        try {
+            Method method = ActivityOptions.class.getMethod(methodName, int.class);
+            method.invoke(options, windowMode);
+        } catch (Exception e) {
+            e.printStackTrace();
+        }
+        
+        
         return options.toBundle();
     }
+
+    public void setWrapperContext(Context context) {
+        this.context = context;
+    }
 }
diff --git a/src/com/android/launcher3/views/ActivityContext.java b/src/com/android/launcher3/views/ActivityContext.java
index 31f5d6541a..43c91c8bc2 100644
--- a/src/com/android/launcher3/views/ActivityContext.java
+++ b/src/com/android/launcher3/views/ActivityContext.java
@@ -352,6 +352,8 @@ public interface ActivityContext {
     default RunnableList sendPendingIntentWithAnimation(
             @NonNull View v, PendingIntent intent, @Nullable ItemInfo item) {
         ActivityOptionsWrapper options = getActivityLaunchOptions(v, item);
+        Context context = (Context) this;
+        options.setWrapperContext(context);
         try {
             intent.send(null, 0, null, null, null, null, options.toBundle());
             if (item != null) {
@@ -396,6 +398,8 @@ public interface ActivityContext {
                 : makeDefaultActivityOptions(item != null && item.animationType == DEFAULT_NO_ICON
                         ? SPLASH_SCREEN_STYLE_SOLID_COLOR : -1 /* SPLASH_SCREEN_STYLE_UNDEFINED */);
         UserHandle user = item == null ? null : item.user;
+
+        options.setWrapperContext(context);
         Bundle optsBundle = options.toBundle();
         // Prepare intent
         intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
-- 
2.34.1

