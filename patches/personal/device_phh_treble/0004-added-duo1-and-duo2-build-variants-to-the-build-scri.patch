From b3997aefe872464622ea6fbf72213f2ea098805a Mon Sep 17 00:00:00 2001
From: Archfx <cybx@live.com>
Date: Mon, 15 Jul 2024 11:37:20 -0400
Subject: [PATCH] added duo1 and duo2 build variants to the build script

---
 aosp.mk                                |  4 ++++
 files/com.microsoft.surface.duo_v1.xml |  7 +++++++
 files/device_state_configuration.xml   | 18 +++++++++++++++++
 generate.sh                            | 28 +++++++++++++++++++++++---
 phh-on-data.sh                         | 14 +++++++++++++
 sepolicy/hal.te                        |  2 ++
 sepolicy/service.te                    |  1 +
 sepolicy/service_contexts              |  5 +++++
 sepolicy/surface.te                    |  5 +++++
 system.prop                            |  8 ++++++++
 10 files changed, 89 insertions(+), 3 deletions(-)
 create mode 100644 aosp.mk
 create mode 100644 files/com.microsoft.surface.duo_v1.xml
 create mode 100644 files/device_state_configuration.xml
 create mode 100644 sepolicy/surface.te

diff --git a/aosp.mk b/aosp.mk
new file mode 100644
index 0000000..6493ba4
--- /dev/null
+++ b/aosp.mk
@@ -0,0 +1,4 @@
+$(call inherit-product, vendor/ponces/config/common.mk)
+
+PRODUCT_SYSTEM_DEFAULT_PROPERTIES += \
+    ro.system.ota.json_url=https://raw.githubusercontent.com/Archfx/duo-de/main-14/config/ota.json
diff --git a/files/com.microsoft.surface.duo_v1.xml b/files/com.microsoft.surface.duo_v1.xml
new file mode 100644
index 0000000..2a3cfcd
--- /dev/null
+++ b/files/com.microsoft.surface.duo_v1.xml
@@ -0,0 +1,7 @@
+<?xml version="1.0" encoding="utf-8"?>
+<permissions>
+    <unavailable-feature name="com.microsoft.device.display.displaymask" />
+    <oem-permissions>
+        <permission name="surface.permission.USE_OEM_PRIVATE_SENSORS" />
+    </oem-permissions>
+</permissions>
\ No newline at end of file
diff --git a/files/device_state_configuration.xml b/files/device_state_configuration.xml
new file mode 100644
index 0000000..1647d08
--- /dev/null
+++ b/files/device_state_configuration.xml
@@ -0,0 +1,18 @@
+<device-state-config>
+  <device-state>
+    <identifier>0</identifier>
+    <name>CLOSED</name>
+  </device-state>
+  <device-state>
+    <identifier>1</identifier>
+    <name>HALF_OPENED</name>
+  </device-state>
+  <device-state>
+    <identifier>2</identifier>
+    <name>OPENED</name>
+  </device-state>
+  <device-state>
+    <identifier>3</identifier>
+    <name>FOLDED</name>
+  </device-state>
+</device-state-config>
\ No newline at end of file
diff --git a/generate.sh b/generate.sh
index 4c7690a..77dfd89 100644
--- a/generate.sh
+++ b/generate.sh
@@ -18,12 +18,15 @@ for part in a ab;do
 	for apps in vanilla gapps foss gapps-go;do
 		for arch in arm64 arm a64;do
 			for su in yes no;do
+			for duo in "" _duo1 _duo2; do
 				apps_suffix=""
 				apps_script=""
 				apps_name=""
 				extra_packages=""
+				copy_files=""
+				duo_script=""
                 vndk="vndk.mk"
-		optional_base=""
+				optional_base=""
 				if [ "$apps" == "gapps" ];then
 					apps_suffix="g"
 					[[ "$arch" == "a64" ]] && base="arm" || base="arm64"
@@ -57,7 +60,7 @@ for part in a ab;do
 					su_suffix='S'
 					extra_packages+=' phh-su me.phh.superuser'
 				fi
-
+				
 				part_suffix='a'
 				if [ "$part" == 'ab' ];then
 					part_suffix='b'
@@ -65,7 +68,20 @@ for part in a ab;do
 					optional_base='$(call inherit-product, device/phh/treble/base-sas.mk)'
 				fi
 
-				target="treble_${arch}_${part_suffix}${apps_suffix}${su_suffix}"
+				duo_suffix=''
+				if [ "$duo" == "_duo1" ];then
+					duo_suffix='d1'
+					extra_packages+=' PostureProcessor SurfaceDuoGeneralOverlay SurfaceDuo1DisplayFeaturesWMShellOverlay SurfaceDuo1NoHingeAndroidOverlay SurfaceDuo1NoHingeWMShellOverlay SurfaceDuo1DisplayFeaturesOverlay SurfaceDuo2DisplayFeaturesOverlay SurfaceDuo2DisplayFeaturesWMShellOverlay SurfaceDuo2NoHingeAndroidOverlay SurfaceDuo2NoHingeWMShellOverlay SurfaceDuo2PostureProcessorOverlay SurfaceDuoSettingsOverlay SurfaceDuoSettingsIconsOverlay SurfaceDuoAppHintingOverlay'
+					copy_files=" device/phh/treble/files/com.microsoft.surface.duo_v1.xml:system/etc/permissions/com.microsoft.surface.duo_v1.xml device/phh/treble/files/device_state_configuration.xml:system/etc/devicestate/device_state_configuration.xml"
+					duo_script='$(call inherit-product-if-exists, vendor/surface/prebuilts/bootanimation/bootanimation.mk)'
+				elif [ "$duo" == "_duo2" ];then
+					duo_suffix='d2'
+					extra_packages+=' PostureProcessorV2 SurfaceDuoGeneralOverlay SurfaceDuo1DisplayFeaturesWMShellOverlay SurfaceDuo1NoHingeAndroidOverlay SurfaceDuo1NoHingeWMShellOverlay SurfaceDuo1DisplayFeaturesOverlay SurfaceDuo2DisplayFeaturesOverlay SurfaceDuo2DisplayFeaturesWMShellOverlay SurfaceDuo2NoHingeAndroidOverlay SurfaceDuo2NoHingeWMShellOverlay SurfaceDuo2PostureProcessorOverlay SurfaceDuoSettingsOverlay SurfaceDuoSettingsIconsOverlay SurfaceDuoAppHintingOverlay'
+					copy_files=" device/phh/treble/files/com.microsoft.surface.duo_v1.xml:system/etc/permissions/com.microsoft.surface.duo_v1.xml device/phh/treble/files/device_state_configuration.xml:system/etc/devicestate/device_state_configuration.xml"
+					duo_script='$(call inherit-product-if-exists, vendor/surface/prebuilts/bootanimation/bootanimation.mk)'
+				fi
+
+				target="treble_${arch}_${part_suffix}${apps_suffix}${su_suffix}${duo_suffix}"
 
 				baseArch="$arch"
 				if [ "$arch" = "a64" ];then
@@ -96,8 +112,14 @@ PRODUCT_CHARACTERISTICS := device
 
 PRODUCT_PACKAGES += $extra_packages
 
+PRODUCT_COPY_FILES += $copy_files
+
+$duo_script
+
 EOF
 echo -e '\t$(LOCAL_DIR)/'$target.mk '\' >> AndroidProducts.mk
+
+			done
 			done
 		done
 	done
diff --git a/phh-on-data.sh b/phh-on-data.sh
index 472d16e..f36b15e 100644
--- a/phh-on-data.sh
+++ b/phh-on-data.sh
@@ -29,3 +29,17 @@ if [ "$vndk" = 28 ];then
     mount $minijailSrc64 /vendor/lib64/libminijail.so
     mount $minijailSrc /vendor/lib/libminijail.so
 fi
+
+if [ "$(getprop  persist.sys.phh.duo.disable_hinge)" -eq 1 ]; then
+    setprop vendor.display.bezel_size 0
+    setprop vendor.display.default_bezel_size 0
+    setprop vendor.display.hinge_width_pixels 0
+fi
+
+if [ "$(getprop  persist.sys.thain.duo.enable_settings_icons)" -eq 1 ]; then
+    setprop vendor.thain.settings_icon 1
+fi
+
+if [ "$(getprop  persist.sys.thain.duo.app_hinting)" -eq 1 ]; then
+    setprop vendor.thain.app_hinting 1
+fi
\ No newline at end of file
diff --git a/sepolicy/hal.te b/sepolicy/hal.te
index cb44422..cb4262d 100644
--- a/sepolicy/hal.te
+++ b/sepolicy/hal.te
@@ -5,6 +5,8 @@ hal_server_domain(hal_fingerprint_oppo_compat, hal_fingerprint)
 type hal_fingerprint_oppo_compat_exec, exec_type, vendor_file_type, file_type;
 init_daemon_domain(hal_fingerprint_oppo_compat)
 
+# Surface Display Topology
+type hal_displaytopology_hwservice, hwservice_manager_type;
 
 type hal_fingerprint_oppo, domain;
 allow hal_fingerprint_oppo vendor_default_prop:property_service { set };
diff --git a/sepolicy/service.te b/sepolicy/service.te
index a9120f9..0015290 100644
--- a/sepolicy/service.te
+++ b/sepolicy/service.te
@@ -1 +1,2 @@
 type qcrilam_service,    service_manager_type;
+type duo_service, service_manager_type;
\ No newline at end of file
diff --git a/sepolicy/service_contexts b/sepolicy/service_contexts
index a390e3f..2b42271 100644
--- a/sepolicy/service_contexts
+++ b/sepolicy/service_contexts
@@ -14,3 +14,8 @@ android.hardware.bluetooth.audio.IBluetoothAudioProviderFactory/sysbta    u:obje
 
 # QcRilAm
 me.phh.qcrilam                                                            u:object_r:qcrilam_service:s0
+
+# Surface DisplayTopology HIDL
+vendor.surface.displaytopology::IDisplayTopology                          u:object_r:hal_displaytopology_hwservice:s0
+
+com.thain.duo                                                             u:object_r:duo_service:s0
\ No newline at end of file
diff --git a/sepolicy/surface.te b/sepolicy/surface.te
new file mode 100644
index 0000000..1e24942
--- /dev/null
+++ b/sepolicy/surface.te
@@ -0,0 +1,5 @@
+# add_hwservice(hal_graphics_composer_server, hal_displaytopology_hwservice);
+allow duo_service hal_displaytopology_hwservice:hwservice_manager find;
+allow duo_service hal_graphics_composer_default:binder { call };
+allow system_app hal_displaytopology_hwservice:hwservice_manager find;
+allow system_app hal_graphics_composer_default:binder { call };
\ No newline at end of file
diff --git a/system.prop b/system.prop
index f3c0c45..90afe72 100644
--- a/system.prop
+++ b/system.prop
@@ -49,3 +49,11 @@ bluetooth.profile.sap.server.enabled?=true
 
 # Samsung vendors default to a Samsung-specific gadget for MTP. Set this to use AOSP's functionfs MTP
 vendor.usb.use_ffs_mtp=1
+
+# Override media volume steps
+ro.config.media_vol_steps=25
+ro.config.media_vol_default=8
+
+# surface duo stuff
+persist.sys.thain.duo.enable_settings_icons=1
+persist.sys.thain.duo.app_hinting=0
\ No newline at end of file
-- 
2.34.1

